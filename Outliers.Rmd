---
title: "Outlier detection"
subtitle: "Property prices in Buenos Aires"
author: "Luis Emilio Tisocco"
date: "7/3/2022"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: united
    highlight: tango
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

For this analysis, we'll be using the following libraries: 

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(ggmap)
library(knitr)
library(leaflet)
library(osmdata)
library(sf)
library(tidyverse)
library(ggridges)

#For any missing library, remember to <install.packages('PACKAGE-NAME')>

options(scipen=999) #turn off scientific notation
```

# 1. Data understanting and preparation
    
## 1.1 Loading data

Let's load the all the properties on sale, published on Argenprop during 2021 and explore what's in it:

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
#We'll be using these 2 shape files:

neighbourhoods <- st_read('data/neighbourhood/barrios_badata.shp') %>% 
        st_transform(4326) %>% 
    rename(NEIGHBOURHOOD=BARRIO) %>% 
    select(NEIGHBOURHOOD)

properties <- st_read('data/real-estate/Deptos_Vta_Anual_2021.shp') %>% 
    st_transform(4326) %>% 
    st_join(neighbourhoods) # geo info

names(properties)
```

We'll keep the property prices and neighbourhood columns:

```{r message=FALSE, warning=FALSE}
properties <-  properties %>%  
    select(OBJECTID, DOLARES, U_S_M2, NEIGHBOURHOOD) %>% 
    rename(USD=DOLARES,
           USDm2=U_S_M2)

kable(head(properties))
```


## 1.2 Spatial distribution of properties


```{r message=FALSE, warning=FALSE, include=FALSE}
properties <- properties %>%  
    mutate(long = unlist(map(properties$geometry,1)), 
           lat = unlist(map(properties$geometry,2)))
```

```{r message=FALSE, warning=FALSE, out.width = '100%'}
qpal <- colorQuantile('RdYlGn', reverse=TRUE, properties$USDm2, n = 10)

leaflet(properties) %>%
  setView(-58.44104, -34.62264, zoom = 11) %>% 
  addTiles() %>%
  addProviderTiles(providers$CartoDB) %>%
  addCircles(lng = ~long, lat = ~lat, weight = 5,
             fillOpacity = .2, color = ~qpal(USDm2),
             popup = ~ paste('<strong>','Neighbourhood: ','</strong>', NEIGHBOURHOOD, '<br/>',
                             '<strong>', 'USD/m2: ', '</strong>', USDm2)) %>% 

   addLegend("bottomright", pal = qpal, values = ~USDm2, 
            title = "Price deciles", opacity = 0.75) 
```


## 1.3 Unrepresentative values

```{r, message=FALSE, warning=FALSE, out.width = '100%', fig.height=12}
ggplot(properties)+
    geom_boxplot(aes(x=USDm2, y=NEIGHBOURHOOD, fill=NEIGHBOURHOOD), show.legend = FALSE) +
    scale_fill_viridis_d(option = 'magma')+
    theme_minimal()
```

Let's find out the median price for each neighborhood to add it to the database:

```{r}
mean_1 <- properties %>% 
    as.data.frame() %>% 
    select(-geometry) %>% 
    group_by(NEIGHBOURHOOD) %>% 
    summarise(MEAN_BEFORE=mean(USDm2))

properties <- left_join(properties, mean_1, by='NEIGHBOURHOOD')
```


```{r}
p1 <- ggplot() +
    geom_density_ridges_gradient(data=properties, aes(x = USDm2, y = reorder(NEIGHBOURHOOD, -MEAN_BEFORE), 
                                                                                    fill = ..x..),
                                 color= 'grey50', scale = 3, rel_min_height = 0.01, show.legend = FALSE) +
    geom_boxplot(data=properties,aes(x=USDm2, y=NEIGHBOURHOOD), fill='white', color='black', alpha=.3, show.legend = FALSE) +
  labs(title = 'Density plot per neighbourhood including extreme values') +
    scale_fill_viridis_c(option = 'magma', direction = -1, alpha=.2)+
    labs (x='USD/m2',
          y='NEIGHBOURHOOD')+
    theme_minimal()

p1
```


```{r message=FALSE, warning=FALSE}
Q1=quantile(properties$USDm2, c(.25))
Q3=quantile(properties$USDm2, c(.75))
IQR= Q3-Q1

lim_low=Q1-1.5*IQR
lim_high=Q3+1.5*IQR
```

```{r message=FALSE, warning=FALSE}
properties_filter <- filter(properties, USDm2 >lim_low & USDm2 < lim_high)
```


Now, let's add to the dataframe the mean price for each neighbourhood after bringing the outliers out of the sample

```{r message=FALSE, warning=FALSE}
mean_2 <- properties_filter %>% 
    as.data.frame() %>% 
    select(-geometry) %>% 
    group_by(NEIGHBOURHOOD) %>% 
    summarise(MEAN_AFTER=mean(USDm2))

properties_filter <- left_join(properties_filter, mean_2, by='NEIGHBOURHOOD')

MEAN_N <- mean_1 %>% 
    left_join(mean_2, by='NEIGHBOURHOOD') %>% 
    mutate(DIF=MEAN_AFTER/MEAN_BEFORE*100)
```


Let's see what it looks like:

```{r message=FALSE, warning=FALSE, out.width = '100%', fig.height=12}
p2 <- ggplot() +
    geom_density_ridges_gradient(data=properties_filter, aes(x = USDm2, y = reorder(NEIGHBOURHOOD, -MEAN_AFTER), 
                                                                                    fill = ..x..),
                                 color= 'grey50', scale = 3, rel_min_height = 0.01, show.legend = FALSE) +
    geom_boxplot(data=properties_filter,aes(x=USDm2, y=NEIGHBOURHOOD), fill='white', color='black', alpha=.3, show.legend = FALSE) +
  labs(title = 'Density plot per neighbourhood including extreme values') +
    scale_fill_viridis_c(option = 'magma', direction = -1, alpha=.2)+
    labs (x='USD/m2',
          y='NEIGHBOURHOOD')+
    theme_minimal()

p2
```

We-ve managed to get a much more fitted data!


